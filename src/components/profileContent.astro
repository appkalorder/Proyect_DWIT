---
import Panel from "@components/PanelBody.astro";
---

<div class="max-w-2xl mx-auto p-4">
  <Panel>
    <h2 class="text-xl font-bold mb-6 text-gray-900 dark:text-white">
      Editar Perfil
    </h2>

    <form id="profileForm" class="space-y-6">
      <div>
        <label
          class="block text-sm font-medium text-gray-700 dark:text-gray-300"
        >
          Nombre
        </label>
        <input
          type="text"
          name="nombre"
          id="nombre"
          class="mt-1 py-1 px-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        />
      </div>

      <div>
        <label
          class="block text-sm font-medium text-gray-700 dark:text-gray-300"
        >
          Correo
        </label>
        <input
          type="email"
          name="correo"
          id="correo"
          class="mt-1 py-1 px-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        />
      </div>

      <div>
        <label
          class="block text-sm font-medium text-gray-700 dark:text-gray-300"
        >
          Edad
        </label>
        <input
          type="number"
          name="edad"
          id="edad"
          min="0"
          max="120"
          class="mt-1 py-1 px-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        />
      </div>

      <div>
        <label
          class="block text-sm font-medium text-gray-700 dark:text-gray-300"
        >
          Fecha de Inicio de Entrenamiento
        </label>
        <input
          type="date"
          name="tiempo_entrenando"
          id="tiempo_entrenando"
          class="mt-1 py-1 px-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        />
      </div>

      <div class="flex justify-end space-x-3">
        <button
          type="button"
          onclick="window.history.back()"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 rounded-md"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="px-4 py-2 text-sm font-medium dark:bg-gray-100 bg-gray-900 text-gray-100 dark:text-gray-900 hover:bg-gray-700 dark:hover:bg-gray-400 rounded-md"
        >
          Guardar Cambios
        </button>
      </div>
    </form>
  </Panel>
</div>

<script>
  const form = document.getElementById("profileForm") as HTMLFormElement;
  const user = JSON.parse(localStorage.getItem("user") || "{}");

  // Fill form with existing user data
  if (user) {
    Object.keys(user).forEach((key) => {
      const input = document.getElementById(key) as HTMLInputElement;
      if (input) {
        input.value = user[key];
      }
    });
  }

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const updatedUser = {
      ...user,
      nombre: formData.get("nombre"),
      correo: formData.get("correo"),
      edad: formData.get("edad"),
      tiempo_entrenando: formData.get("tiempo_entrenando"),
    };

    try {
      const response = await fetch(
        "http://localhost:8080/actualizar_usuario.php",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(updatedUser),
        },
      );

      if (response.ok) {
        // Update localStorage with new data
        localStorage.setItem("user", JSON.stringify(updatedUser));
        window.location.href = "/";
      } else {
        throw new Error("Error al actualizar el perfil");
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Error al actualizar el perfil");
    }
  });
</script>
